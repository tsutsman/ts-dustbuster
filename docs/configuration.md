# Конфігурації ts-dustbuster

Цей документ описує, як керувати поведінкою `cleaner.js` через JSON/YAML конфігурації та пресети. Файл можна передати прапорцем `--config`, а кілька конфігів — каталогом із відповідними файлами. Конфігурації підтримують наслідування через поле `presets` і дозволяють налаштувати очищення для CI/CD та робочих станцій без редагування коду.

## Основні принципи

- Конфігурація має бути об'єктом (мапою ключ-значення).
- Всі шляхи всередині конфігу інтерпретуються відносно каталогу цього файлу.
- Дозволені ключі: `dirs`, `exclude`, `maxAge`, `summary`, `parallel`, `dryRun`, `deep`, `logFile`, `concurrency`, `preview`, `presets`.
- Прапорці (`summary`, `parallel`, `dryRun`, `deep`, `preview`) приймають значення `true`/`false`.
- Поля `dirs` та `exclude` можуть містити рядок або масив рядків.
- `maxAge` задається як тривалість у годинах (`12`, `0.5`) або з суфіксом `m`, `h`, `d`, `w` (хвилини, години, дні, тижні).
- `concurrency` приймає додатне число або `null` для повернення до режиму за замовчуванням.
- Якщо потрібні спільні налаштування, використовуйте поле `presets` для підключення інших файлів.

## Базова структура JSON

```json
{
  "dirs": ["./tmp", "/var/cache/app"],
  "exclude": ["./tmp/keep.log", "./tmp/snapshots"],
  "maxAge": "7d",
  "summary": true,
  "parallel": true,
  "concurrency": 4,
  "logFile": "./logs/cleanup.log"
}
```

### Пояснення

- `dirs` — перелік директорій для очищення. Допускаються як абсолютні, так і відносні шляхи.
- `exclude` — шляхи, що ніколи не видаляються (працюють рекурсивно).
- `maxAge` — мінімальний вік файлів/папок для видалення. У прикладі видалятимуться лише об'єкти старші за 7 днів.
- `summary` — наприкінці роботи буде виведено статистику (кількість файлів, тек, звільнений простір).
- `parallel` і `concurrency` — вмикають паралельне очищення та обмежують кількість одночасних операцій.
- `logFile` — шлях до файлу, куди записується перебіг очищення.

## YAML з глибоким очищенням та пресетами

```yaml
presets:
  - ./base-common.yaml
  - prod-extra

dirs:
  - ../artifacts
  - /var/lib/app/cache
exclude:
  - ../artifacts/.gitkeep
maxAge: 48h
summary: true
parallel: true
deep: true
preview: false
dryRun: false
concurrency: 8
logFile: ../logs/prod-clean.log
```

### Як працюють пресети

- Поле `presets` приймає список назв або шляхів.
- Якщо вказати назву без шляху, інструмент шукатиме файл у тому ж каталозі, у підкаталозі `presets`, у поточному робочому каталозі та в комплекті пресетів програми.
- Порядок має значення: останні пресети та поточний файл можуть перевизначати попередні значення, а списки (`dirs`, `exclude`) об'єднуються.
- Щоб уникнути циклів, переконайтесь, що пресети не підключають один одного рекурсивно.

## Каталоги конфігів

Передача каталогу `--config ./configs` змусить утиліту прочитати всі файли з розширеннями `.json`, `.yaml`, `.yml` у алфавітному порядку та об'єднати їх у єдину конфігурацію. Це корисно, якщо потрібно розділити налаштування за середовищами:

```
configs/
├── 10-common.yaml
├── 20-ci.json
└── 30-overrides.yaml
```

Кожен файл може підключати додаткові пресети й містити тільки змінені поля — відсутні значення не перезаписують попередні налаштування.

## Рекомендації для CI/CD

- Зберігайте конфіги у репозиторії, щоб забезпечити відтворюваність і код-рев'ю.
- Використовуйте окремі файли для базових налаштувань, середовищ (`dev`, `staging`, `prod`) та доповнень під конкретні пайплайни.
- Додавайте `logFile` із шляхом до артефактів збірки, щоб мати історію очищень.
- У режимі попереднього перегляду (`preview: true`) можна запускати dry-run у перевірочних пайплайнах, але для автоматичних задач зазвичай вимикайте `preview` і `dryRun`.
- Контролюйте паралельність (`concurrency`), щоб не перевантажити файлову систему CI-агента.
- Для критичних директорій встановіть `maxAge`, щоб уникнути видалення свіжих артефактів.

## Перевірка конфігів

- `node cleaner.js --config ./configs/prod.yaml --validate` — прочитає всі пресети та конфігурації, повідомить про помилки та завершить роботу з кодом 0/1 без очищення.
- `node cleaner.js --config ./configs --validate` — зручно в CI, якщо конфіги розбиті на кілька файлів у каталозі.
- `node cleaner.js --config-schema > schema.json` — згенерує JSON Schema, яку можна використати з `ajv`, `spectral`, GitHub Actions чи іншими валідаторами.

## Діагностика типових помилок

- Якщо шлях у `dirs` або `exclude` не існує, він буде пропущений без помилки. Щоб помітити такі ситуації, переглядайте журнал або вмикайте `summary`.
- Некоректний шлях у `logFile` спричинить повідомлення про помилку, після чого утиліта продовжить роботу без запису логу.
- `preview: true` працює лише в інтерактивному терміналі. У безголових середовищах (CI, cron) відповідні каталоги не очищаються й виводиться попередження.
- Коли пресет не знайдено, у консолі з'явиться точне повідомлення з назвою або шляхом. Перевірте правопис та наявність файлу в каталозі `presets`.

## Типові сценарії

1. **Локальна розробка:**
   - Створіть `configs/local.yaml` з `dirs: ["~/Library/Caches", "./tmp"]`, `preview: true`, `dryRun: true`.
   - Запускайте `node cleaner.js --config configs/local.yaml` та підтверджуйте каталоги вручну.
2. **Нічний CI:**
   - Комбінація файлів `configs/10-common.yaml` та `configs/50-nightly.yaml` з `parallel: true`, `concurrency: 6`, `summary: true`.
   - Виконуйте `node cleaner.js --config configs` у cron/Task Scheduler.
3. **Очищення релізних агентів:**
   - Використовуйте пресет `prod-extra` для додаткових директорій, вмикайте `logFile` і збирайте журнал як артефакт.

Дотримуйтесь цих рекомендацій, щоб централізовано керувати очищенням і вписувати ts-dustbuster у дорожню карту автоматизації.
